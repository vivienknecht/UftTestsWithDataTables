# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main

parameters:
  - name: unitTestResultsGlobPattern
    type: string
    default: "build/Results.xml"

pool: Default

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "22.x"
    displayName: "Use Node.js"

  # - task: octane-start-task-private@1
  #   inputs:
  #     OctaneServiceConnection: 'octaneConnectionForDiscovery'
  #     WorkspaceList: '6001'
  #     CreatePipelineCheckbox: true

  - task: octane-test-runner-start-task-private@1
    inputs:
      OctaneServiceConnection: "octaneConnectionForDiscovery"
      WorkspaceList: "6001"
      Framework: "uft"
      GitRepositoryURL: "https://github.com/vivienknecht/UftTestsWithDataTables"

  # - powershell: |
  #     node dist/task/index.js --action="convertTests" --framework="uft" --testsToRun=${env:TESTSTORUN} --logLevel=1
  #   displayName: TestConversion

  - checkout: self
    fetchDepth: 0

  - task: DownloadPipelineArtifact@2
    displayName: "Download last successful commit SHA"
    inputs:
      buildType: "specific"
      project: "$(System.TeamProjectId)"
      definition: "$(System.DefinitionId)"
      buildVersionToDownload: "latestFromBranch"
      branchName: "$(Build.SourceBranch)"
      artifactName: "last-successful"
      downloadPath: "$(Pipeline.Workspace)\\last-successful"
    continueOnError: true

  - powershell: |
      ./eng/detect-changed-files.ps1
    displayName: Detect changed files since last successful run

  # - powershell: |
  #     $artifactPath = "$(Pipeline.Workspace)/last-successful/last_successful_commit.txt"

  #     if (Test-Path $artifactPath) {
  #       $last = Get-Content $artifactPath
  #       Write-Host "Found last successful commit: $last"
  #     }
  #     #Necessary for first run or when no artifacts can be found
  #     else {
  #       $last = "$(Build.SourceVersion)^"
  #       Write-Host "No previous successful run found. Using fallback commit: $last"
  #     }
  #     Write-Host "##vso[task.setvariable variable=LAST_SUCCESSFUL_COMMIT]$last"
  #   displayName: "Resolve last successful commit"

  # - task: PowerShell@2
  #   name: GetFiles
  #   inputs:
  #     targetType: inline
  #     script: |
  #       git fetch --all
  #       Write-Host "Diff from $Env:LAST_SUCCESSFUL_COMMIT to HEAD"
  #       $files = git diff --name-status -M -z $Env:LAST_SUCCESSFUL_COMMIT HEAD | Out-String
  #       if (-not $files) { $files = "" }
  #       $encoded = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($files))
  #       Write-Host "Modified files: $files"
  #       Write-Host "##vso[task.setvariable variable=MODIFIED_FILES]$encoded"
  #   displayName: "Get changed files since last successful run"

  - task: octane-get-params-task-private@1
    inputs:
      OctaneServiceConnection: 'octaneConnectionForDiscovery'

  - powershell: |
      node dist/task/index.js --action="discoverTests" --isFullScan=false --path="$Env:BUILD_SOURCESDIRECTORY" --octaneUrl="$(octaneUrl)" --sharedSpace="$(octaneSharedSpaceId)" --workspace="$env:WORKSPACE" --clientSecret="$(octaneClientSecret)" --clientId="$(octaneClientId)" --logLevel=1
      #node dist/task/index.js --action="discoverTests" --isFullScan=false --path="$Env:BUILD_SOURCESDIRECTORY" --octaneUrl="http://localhost:8080/dev" --sharedSpace="1001" --workspace="$env:WORKSPACE" --clientSecret="@-pV0TAtzP47=my(e5nhafO" --clientId="azure-api-key_kvd21vm6499glie73225910oy" --logLevel=1
    env:
      MODIFIED_FILES_PATH: $(Pipeline.Workspace)/modified_files.bin
      REPOURL: $(Build.Repository.Uri)
    displayName: Discovery

  - powershell: |
      echo $(Build.SourceVersion) > last_successful_commit.txt
    displayName: "Store current commit SHA"

  - publish: last_successful_commit.txt
    artifact: last-successful
    displayName: "Publish last successful commit SHA"

  - powershell: |
      Write-Host "Current Directory:"
      Get-Location
      echo "Building..."
      mkdir build
      $ESCAPED_DIR = $Env:BUILD_SOURCESDIRECTORY.Replace('\', '\\')
      $content = @"
      $testsToRunConverted
      "@
      Set-Content -Path "./build/testsToRun.mtbx" -Value $env:testsToRunConverted
      Set-Content -Path ./build/Props.txt -Value "runType=FileSystem"
      Add-Content -Path ./build/Props.txt -Value "resultsFilename=build\\Results.xml"
      Add-Content -Path ./build/Props.txt -Value "Test1=$ESCAPED_DIR\\build\\testsToRun.mtbx"
      #Add-Content -Path ./build/Props.txt -Value "Test1=$ESCAPED_DIR\\browsers\\TestWDataTableRenamed"
      Add-Content -Path ./build/Props.txt -Value "resultUnifiedTestClassname=true"
      Add-Content -Path ./build/Props.txt -Value "resultTestNameOnly=true"
      Get-Content -Path ./build/Props.txt
    displayName: Build

  - powershell: |
      echo "Testing..."
      echo $PWD
      Test-Path "./build/Props.txt" -PathType leaf
      Get-Content -Path ./build/Props.txt
      Start-Process "FTToolsLauncher_net48.exe" -ArgumentList "-paramfile `"$(Get-Location)\build\Props.txt`"" -Wait
      echo "Please check the [$PWD\build\Results.xml] file."

  - task: octane-end-task-private@1
    inputs:
      OctaneServiceConnection: "octaneConnectionForDiscovery"
      WorkspaceList: "6001"
      Framework: "uft"
    env:
      UNIT_TEST_RESULTS_GLOB_PATTERN: ${{ parameters.unitTestResultsGlobPattern }}
