# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main

pool: Default

steps:
  - task: octane-start-task-private@1
    inputs:
      OctaneServiceConnection: 'octaneConnectionForDiscovery'
      WorkspaceList: '4001'
      CreatePipelineCheckbox: true
  - task: octane-test-runner-start-task-private@1
    inputs:
      OctaneServiceConnection: "octaneConnectionForDiscovery"
      WorkspaceList: "4001"
      Framework: "uft"
      GitRepositoryURL: $(Build.Repository.Uri)

  - checkout: self
    fetchDepth: 0

  - task: DownloadPipelineArtifact@2
    inputs:
      buildType: "specific"
      project: "$(System.TeamProjectId)"
      definition: "$(System.DefinitionId)"
      buildVersionToDownload: "latestFromBranch"
      branchName: "$(Build.SourceBranch)"
      artifactName: "last-successful"
      downloadPath: "$(Pipeline.Workspace)\\last-successful"
    displayName: "Download last successful commit SHA"

  # - powershell: |
  #     ./eng/detect-changed-files.ps1
  #   displayName: Detect changed files since last successful run

  - powershell: |
      Write-Host "=== Detect changed files since last successful run ==="

      $workspace     = $env:PIPELINE_WORKSPACE
      $currentCommit = $env:BUILD_SOURCEVERSION.Trim()

      $artifactPath = Join-Path $workspace "last-successful"
      $commitFile   = Join-Path $artifactPath "last_successful_commit.txt"

      # Resolve baseline commit
      if (Test-Path $commitFile) {
          $lastCommit = (Get-Content $commitFile -Raw).Trim()
          Write-Host "Found last successful commit: $lastCommit"
      }
      else {
          $lastCommit = "$currentCommit^"
          Write-Host "No previous successful run found. Using fallback commit: $lastCommit"
      }

      Write-Host "##vso[task.setvariable variable=LAST_SUCCESSFUL_COMMIT]$lastCommit"

      # Ensure full git history
      git fetch --all --prune

      Write-Host "Diffing $lastCommit -> HEAD"

      $files = git diff --name-status -M -z $lastCommit HEAD
      if (-not $files) { $files = "" }

      $path = "$env:PIPELINE_WORKSPACE/modified_files.bin"

      [System.IO.File]::WriteAllBytes(
          $path,
          [Text.Encoding]::UTF8.GetBytes($files)
      )

      Write-Host "Modified files written to $path"

      # Persist current commit for next run
      $currentCommit | Out-File "last_successful_commit.txt" -Encoding ascii
    displayName: "Detect changed files since last successful run"

  - task: octane-get-params-task-private@1
    inputs:
      OctaneServiceConnection: "octaneConnectionForDiscovery"

  - powershell: |
      Write-Host "Build.Repository.Uri = $(Build.Repository.Uri)"
    displayName: 'Echo Build.Repository.Uri'

  - powershell: |
      node dist/cli/index.js --action="discoverTests" --isFullScan=true --path="$env:BUILD_SOURCESDIRECTORY" --octaneUrl="$(octaneUrl)" --sharedSpace="$(octaneSharedSpaceId)" --workspace="$env:WORKSPACE" --clientSecret="$(octaneClientSecret)" --clientId="$(octaneClientId)" --logLevel=1    env:
    env:
      MODIFIED_FILES_PATH: $(Pipeline.Workspace)/modified_files.bin
      REPOURL: $(Build.Repository.Uri)
    displayName: Discovery

  - powershell: |
      echo $(Build.SourceVersion) > last_successful_commit.txt
    displayName: "Store current commit SHA"

  - publish: last_successful_commit.txt
    artifact: last-successful
    displayName: "Publish last successful commit SHA"
